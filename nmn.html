<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iHealthÊ®°Êì¨Âô® - ÂÖ®Êï¥ÂêàÁâà</title>
    <style>
        :root {
            --bg-color: #f0f0f2;
            --dot-color: #c0c0c5;
            --text-color: #1d1d1f;
            --card-bg: #ffffff;
            --line-color: #98989d;
            --btn-primary: #0071e3;
            --btn-hover: #0077ed;
            --node-shadow: 0 4px 8px rgba(0,0,0,0.1);
            
            --tag-l1: #e5e7eb; --tag-l1-text: #6b7280;
            --tag-l2: #dbeafe; --tag-l2-text: #1e40af;
            --tag-l3: #dcfce7; --tag-l3-text: #166534;
            --tag-l4: #fce7f3; --tag-l4-text: #9d174d;

            --bv-tag-bg: #fff7ed;
            --bv-tag-border: #fdba74;
            --bv-tag-text: #c2410c;

            --stats-bg: rgba(255, 255, 255, 0.95);
            --stats-border: #e5e5e5;
        }

        [data-theme="dark"] {
            --bg-color: #1c1c1e;
            --dot-color: #333333;
            --text-color: #f5f5f7;
            --card-bg: #2c2c2e;
            --line-color: #555558;
            --btn-primary: #0a84ff;
            --node-shadow: 0 6px 16px rgba(0,0,0,0.4);
            --tag-l1: #3a3a3c; --tag-l1-text: #9ca3af;
            --tag-l2: #1e3a8a; --tag-l2-text: #93c5fd;
            --tag-l3: #14532d; --tag-l3-text: #86efac;
            --tag-l4: #831843; --tag-l4-text: #fbcfe8;
            --bv-tag-bg: #431407;
            --bv-tag-border: #9a3412;
            --bv-tag-text: #fdba74;

            --stats-bg: rgba(44, 44, 46, 0.95);
            --stats-border: #3a3a3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 2px, transparent 2px);
            background-size: 24px 24px;
            color: var(--text-color);
            margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        /* Stats Bar */
        .stats-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--stats-bg);
            border-top: 1px solid var(--stats-border);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 198; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border-radius: 16px 16px 0 0;
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(50px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column;
        }

        .stats-bar.expanded { height: 75vh; } /* Â¢ûÂä†È´òÂ∫¶‰ª•ÂÆπÁ¥çÊåâÈàï */

        .stats-scroll-area {
            flex: 1; overflow-y: auto; padding-bottom: 20px;
            -webkit-overflow-scrolling: touch; /* iOS Momentum Scroll */
        }

        .stats-handle { width: 40px; height: 5px; background-color: var(--line-color); border-radius: 3px; margin: 8px auto 4px auto; opacity: 0.5; flex-shrink: 0; }

        .stats-header { display: flex; justify-content: space-around; align-items: center; height: 34px; padding: 0 16px; cursor: pointer; flex-shrink: 0; }
        .stats-header-item { font-size: 0.9rem; font-weight: 500; display: flex; flex-direction: column; align-items: center; line-height: 1.1; }
        .stats-header-item span { font-size: 0.7rem; opacity: 0.7; margin-bottom: 2px; }
        .stats-header-item strong { color: var(--text-color); font-family: monospace; font-size: 1rem; }
        .stats-header-item.highlight strong { color: #10b981; }

        .stats-content { padding: 16px; opacity: 0; transition: opacity 0.2s; pointer-events: none; display: flex; flex-direction: column; gap: 16px; }
        .stats-bar.expanded .stats-content { opacity: 1; pointer-events: auto; }

        .stats-section-title { font-size: 0.85rem; font-weight: 700; color: var(--text-color); opacity: 0.6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .level-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }

        .stat-box { background-color: var(--bg-color); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .stat-box-label { font-size: 0.7rem; opacity: 0.7; }
        .stat-box-value { font-size: 1.1rem; font-weight: 700; font-family: monospace; margin-top: 2px; }

        .level-box { background-color: var(--bg-color); border-radius: 8px; padding: 8px 4px; display: flex; flex-direction: column; align-items: center; }
        .level-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-bottom: 4px; }
        .level-val { font-weight: 700; font-family: monospace; font-size: 1rem; }

        .gen-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .gen-table th { text-align: left; padding: 6px; border-bottom: 1px solid var(--line-color); opacity: 0.6; font-size: 0.75rem; }
        .gen-table td { padding: 8px 6px; border-bottom: 1px solid var(--line-color); font-family: monospace; font-weight: 600; }
        .gen-table tr:last-child td { border-bottom: none; }

        /* Control Buttons Grid */
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .control-btn {
            background-color: var(--bg-color); border: 1px solid var(--line-color); color: var(--text-color);
            padding: 12px; border-radius: 12px; cursor: pointer; font-size: 0.9rem; text-align: center;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .control-btn:active { background-color: var(--line-color); transform: scale(0.98); }
        .control-btn.primary { background-color: var(--btn-primary); color: white; border: none; font-weight: 600; }
        .control-btn.danger { background-color: #fee2e2; color: #ef4444; border-color: #fca5a5; }
        
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* Viewport */
        .tree-container { flex: 1; width: 100%; height: 100%; overflow: hidden; cursor: grab; position: relative; padding-bottom: 100px; }
        .tree-container:active { cursor: grabbing; }
        .pan-layer { position: absolute; top: 0; left: 0; width: max-content; padding: 100px; transform-origin: 0 0; will-change: transform; }
        .pan-layer.smooth-move { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }

        /* Tree Styles */
        .tree { display: flex; flex-direction: column; align-items: center; }
        .node-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; margin: 0 8px; }
        .children-container { display: flex; flex-direction: row; justify-content: center; padding-top: 36px; position: relative; }
        .children-container::before { content: ''; position: absolute; top: 0; left: 50%; width: 2px; height: 36px; background-color: var(--line-color); transform: translateX(-50%); }
        .branch { display: flex; flex-direction: column; align-items: center; position: relative; padding: 0 8px; }
        .branch::before { content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 2px; background-color: var(--line-color); }
        .branch::after { content: ''; position: absolute; top: 0; right: 0; width: 50%; height: 2px; background-color: var(--line-color); }
        .branch:first-child::before { display: none; }
        .branch:last-child::after { display: none; }
        .branch-content { display: flex; flex-direction: column; align-items: center; position: relative; padding-top: 36px; }
        .branch-content::before { content: ''; position: absolute; top: 0; left: 50%; width: 2px; height: 36px; background-color: var(--line-color); transform: translateX(-50%); }

        .line-bv-tag {
            position: absolute; top: -12px; background-color: var(--bv-tag-bg); border: 1px solid var(--bv-tag-border); 
            color: var(--bv-tag-text); font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 12px;
            z-index: 999; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); left: 50%; transform: translateX(-50%);
        }

        .node-card {
            background-color: var(--card-bg); border: 2px solid var(--line-color); border-radius: 12px;
            padding: 16px 8px 10px 8px; width: 120px; height: 190px;
            box-shadow: var(--node-shadow); position: relative; z-index: 2; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: transform 0.2s;
        }
        .node-card.edit-mode { z-index: 100; border-color: var(--btn-primary); transform: scale(1.05); box-shadow: 0 0 0 4px rgba(0,113,227, 0.2), 0 10px 24px rgba(0,0,0,0.15); }
        
        .delete-btn, .sponsor-btn {
            position: absolute; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 20; opacity: 0; transform: scale(0.5); pointer-events: none; transition: all 0.2s;
        }
        .delete-btn { top: -12px; right: -12px; background: #ff3b30; color: white; font-size: 18px; cursor: pointer; }
        .sponsor-btn { top: -12px; left: -12px; background: var(--btn-primary); color: white; font-size: 16px; cursor: pointer; }
        
        @media (hover: hover) { .node-card:hover .delete-btn, .node-card:hover .sponsor-btn { opacity: 1; transform: scale(1); pointer-events: auto; } }
        .node-card.edit-mode .delete-btn, .node-card.edit-mode .sponsor-btn { opacity: 1; transform: scale(1); pointer-events: auto; }

        .sponsor-label { position: absolute; top: 4px; left: 6px; font-size: 0.65rem; color: var(--text-color); opacity: 0.6; font-weight: 600; pointer-events: none; }
        .avatar-circle { width: 36px; height: 36px; border-radius: 50%; background-color: var(--bg-color); border: 1px solid var(--line-color); display: flex; align-items: center; justify-content: center; font-size: 1rem; color: #888; font-weight: bold; margin-top: 4px; }
        .node-name-input, .node-userid-input { width: 100%; border: none; background: transparent; text-align: center; color: var(--text-color); outline: none; }
        .node-name-input { font-size: 0.9rem; font-weight: 700; border-bottom: 1px dashed transparent; }
        .node-name-input:focus { border-bottom-color: var(--btn-primary); }
        .node-userid-input { font-size: 0.7rem; font-family: monospace; margin-bottom: 2px; opacity: 0.7; }
        .node-level-select { width: 90%; border: none; border-radius: 4px; padding: 4px 0; font-size: 0.75rem; text-align: center; cursor: pointer; font-weight: 700; margin-top: auto; }
        .node-card[data-level="L1"] .node-level-select { background-color: var(--tag-l1); color: var(--tag-l1-text); }
        .node-card[data-level="L2"] .node-level-select { background-color: var(--tag-l2); color: var(--tag-l2-text); }
        .node-card[data-level="L3"] .node-level-select { background-color: var(--tag-l3); color: var(--tag-l3-text); }
        .node-card[data-level="L4"] .node-level-select { background-color: var(--tag-l4); color: var(--tag-l4-text); }
        .node-stats { width: 100%; background-color: var(--bg-color); border-radius: 8px; padding: 6px 4px; font-size: 0.7rem; margin-top: 6px; }
        .stat-row { display: flex; justify-content: space-between; }
        .stat-value { font-weight: 700; font-family: monospace; }
        .stat-cash { color: #10b981; } .stat-bv { color: #f59e0b; } .stat-card { color: #8b5cf6; }
        .add-btn { width: 54px; height: 54px; border-radius: 50%; border: 3px dashed var(--line-color); background: transparent; color: var(--line-color); font-size: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-top: 10px; }
        .add-btn:active { border-color: var(--btn-primary); color: var(--btn-primary); background-color: var(--card-bg); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 340px; max-height: 80vh; display: flex; flex-direction: column; }
        .node-list { flex: 1; overflow-y: auto; border: 1px solid var(--line-color); border-radius: 8px; margin-bottom: 10px; }
        .node-list-item { padding: 12px 10px; border-bottom: 1px solid var(--line-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .node-list-info { display: flex; flex-direction: column; }
        .node-list-name { font-weight: 600; font-size: 0.95rem; }
        .node-list-id { font-size: 0.75rem; color: #888; font-family: monospace; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: 1px solid var(--line-color); background: var(--bg-color); color: var(--text-color); }
        .save-indicator { font-size: 0.75rem; color: #10b981; margin-top: 8px; text-align: center; height: 1.2em; }
    </style>
</head>
<body>

    <div class="tree-container" id="viewport">
        <div class="pan-layer" id="panLayer">
            <div id="treeRoot" class="tree"></div>
        </div>
    </div>

    <div class="stats-bar" id="statsBar">
        <div class="stats-handle"></div>
        
        <div class="stats-header" onclick="toggleStats()">
            <div class="stats-header-item">
                <span>Á∏Ω‰∫∫Êï∏</span>
                <strong id="statCount">0</strong>
            </div>
            <div class="stats-header-item highlight">
                <span>Á∏ΩÂ∫óÁçéÈáë</span>
                <strong id="statRootBonus">$0</strong>
            </div>
        </div>
        
        <div class="stats-scroll-area">
            <div class="stats-content">
                <div class="stats-section-title">ÂÖ®Á∂≤Êï∏Êìö</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-box-label">ÁµÑÁπîÊ∑±Â∫¶</span>
                        <span class="stat-box-value" id="statDepth">0</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-box-label">Á∏ΩÁôºÊîæÁçéÈáë</span>
                        <span class="stat-box-value" id="statTotalPayout" style="color: #10b981;">$0</span>
                    </div>
                </div>

                <div class="stats-section-title" style="margin-top: 10px;">Á¥öÂà•ÂàÜ‰Ωà</div>
                <div class="level-grid">
                    <div class="level-box">
                        <div class="level-tag" style="background:var(--tag-l1);color:var(--tag-l1-text)">L1</div>
                        <span class="level-val" id="cntL1">0</span>
                    </div>
                    <div class="level-box">
                        <div class="level-tag" style="background:var(--tag-l2);color:var(--tag-l2-text)">L2</div>
                        <span class="level-val" id="cntL2">0</span>
                    </div>
                    <div class="level-box">
                        <div class="level-tag" style="background:var(--tag-l3);color:var(--tag-l3-text)">L3</div>
                        <span class="level-val" id="cntL3">0</span>
                    </div>
                    <div class="level-box">
                        <div class="level-tag" style="background:var(--tag-l4);color:var(--tag-l4-text)">L4</div>
                        <span class="level-val" id="cntL4">0</span>
                    </div>
                </div>

                <div class="stats-section-title" style="margin-top: 10px;">‰ª£Êï∏Áµ±Ë®à (Ë°ÄÁ∑£Èóú‰øÇ)</div>
                <div style="background: var(--bg-color); border-radius: 8px; padding: 0 10px;">
                    <table class="gen-table">
                        <thead>
                            <tr>
                                <th width="30%">‰ª£Êï∏</th>
                                <th>‰∫∫Êï∏</th>
                                <th width="30%">‰ª£Êï∏</th>
                                <th>‰∫∫Êï∏</th>
                            </tr>
                        </thead>
                        <tbody id="genTableBody"></tbody>
                    </table>
                </div>

                <div class="stats-section-title" style="margin-top: 24px;">Á≥ªÁµ±Êìç‰Ωú</div>
                <div class="save-indicator" id="saveIndicator"></div>
                
                <div class="control-btn primary" onclick="calculateAndRender()" style="margin-bottom: 10px; padding: 16px;">
                    üí∞ Ë®àÁÆóÁçéÈáë (Ë¶èÂâá1)
                </div>

                <div class="controls-grid">
                    <div class="control-btn" id="themeToggle">Â§ñËßÄ: Ëá™Âãï</div>
                    <div class="control-btn" onclick="downloadJSON()">‰∏ãËºâ JSON</div>
                    
                    <div class="file-input-wrapper">
                         <div class="control-btn">Â∞éÂÖ• JSON</div>
                         <input type="file" id="fileInput" accept=".json" onchange="importJSON(this)">
                    </div>
                    
                    <div class="control-btn" onclick="resetView()">ÈáçÁΩÆË¶ñËßí</div>
                </div>
                
                <div class="control-btn danger" onclick="clearAllData()" style="margin-top: 10px;">
                    üóëÔ∏è Ê∏ÖÈô§ÊâÄÊúâÊï∏Êìö
                </div>

                <div style="height: 40px;"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="sponsorModal">
        <div class="modal">
            <div class="modal-title">ÈÅ∏ÊìáÊé®Ëñ¶‰∫∫</div>
            <div class="node-list" id="nodeListContainer"></div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSponsorModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
        const surnames = ["Èô≥", "Êûó", "ÈªÉ", "Âºµ", "Êùé", "Áéã", "Âê≥", "Âäâ", "Ëî°"];
        const names = ["Â§ßÊñá", "Â∞èÊòé", "ÂøóË±™", "ÈõÖÂ©∑", "Ê∑ëËä¨", "ÂÅâÈõÑ", "ÂÆ∂Ë±™", "ÊÄ°Âêõ"];
        const STORAGE_KEY = 'iHealth_Tree_Data';

        function getRandomName() { return surnames[Math.floor(Math.random() * surnames.length)] + names[Math.floor(Math.random() * names.length)]; }
        function generateUserID() { return Math.floor(100000 + Math.random() * 900000).toString(); }

        let treeData; let nodesCache = {}; let parentMap = {}; 

        function initData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.id === 'root') { treeData = parsed; return; }
                } catch (e) { console.error(e); }
            }
            treeData = {
                id: 'root', userID: generateUserID(), name: 'Á∏ΩÂ∫ó‰∏ª', level: 'L4',
                sponsorId: null, pathA: null, pathB: null,
                rewards: { cash: 0, bv: 0, card: 0, pairing: 0 }, totalBvA: 0, totalBvB: 0
            };
        }

        function saveData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(treeData)); showSaveStatus('Â∑≤ÂÑ≤Â≠ò'); } catch (e) { showSaveStatus('ÂÑ≤Â≠òÂ§±Êïó'); } }
        function clearAllData() { if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊï∏Êìö‰∏¶ÈáçÁΩÆÂóéÔºü')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        function showSaveStatus(msg) { const el = document.getElementById('saveIndicator'); el.textContent = msg; setTimeout(() => { el.textContent = ''; }, 2000); }

        function toggleStats() {
            const bar = document.getElementById('statsBar');
            bar.classList.toggle('expanded');
        }

        function calculateGlobalStats() {
            let totalMembers = 0; let maxDepth = 0; let totalPayout = 0; 
            let cntL1 = 0, cntL2 = 0, cntL3 = 0, cntL4 = 0;

            function traverse(node, currentDepth) {
                if (!node) return;
                totalMembers++;
                if (currentDepth > maxDepth) maxDepth = currentDepth;
                totalPayout += (node.rewards.cash || 0) + (node.rewards.pairing || 0);
                
                if (node.level === 'L1') cntL1++;
                else if (node.level === 'L2') cntL2++;
                else if (node.level === 'L3') cntL3++;
                else if (node.level === 'L4') cntL4++;

                traverse(node.pathA, currentDepth + 1); traverse(node.pathB, currentDepth + 1);
            }
            traverse(treeData, 1);

            let sponsorMap = {}; let allNodeIds = Object.keys(nodesCache);
            allNodeIds.forEach(id => {
                const node = nodesCache[id];
                if (node.sponsorId) {
                    if (!sponsorMap[node.sponsorId]) sponsorMap[node.sponsorId] = [];
                    sponsorMap[node.sponsorId].push(node.id);
                }
            });

            let genCounts = [0, 0, 0, 0, 0, 0, 0, 0, 0]; let queue = [{ id: treeData.id, gen: 0 }];
            while (queue.length > 0) {
                let curr = queue.shift();
                if (curr.gen > 0 && curr.gen <= 8) genCounts[curr.gen]++;
                if (curr.gen < 8) {
                    let recruits = sponsorMap[curr.id] || [];
                    recruits.forEach(childId => { queue.push({ id: childId, gen: curr.gen + 1 }); });
                }
            }

            document.getElementById('statCount').textContent = totalMembers;
            const rootBonus = (treeData.rewards.cash || 0) + (treeData.rewards.pairing || 0);
            document.getElementById('statRootBonus').textContent = '$' + rootBonus.toLocaleString();

            document.getElementById('statDepth').textContent = maxDepth;
            document.getElementById('statTotalPayout').textContent = '$' + totalPayout.toLocaleString();
            
            document.getElementById('cntL1').textContent = cntL1;
            document.getElementById('cntL2').textContent = cntL2;
            document.getElementById('cntL3').textContent = cntL3;
            document.getElementById('cntL4').textContent = cntL4;

            const tbody = document.getElementById('genTableBody'); tbody.innerHTML = '';
            for (let i = 1; i <= 8; i+=2) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>Á¨¨ ${i} ‰ª£</td><td style="color:${genCounts[i]>0?'var(--btn-primary)':'inherit'}">${genCounts[i]}</td><td>Á¨¨ ${i+1} ‰ª£</td><td style="color:${genCounts[i+1]>0?'var(--btn-primary)':'inherit'}">${genCounts[i+1]}</td>`;
                tbody.appendChild(tr);
            }
        }

        function getNodeBaseBV(level) { if (level === 'L2') return 80; if (level === 'L3') return 500; if (level === 'L4') return 1000; return 0; }
        function getSponsorReward(level) {
            if (level === 'L2') return { cash: 16, bv: 80, card: 0 };
            if (level === 'L3') return { cash: 100, bv: 500, card: 100 };
            if (level === 'L4') return { cash: 200, bv: 1000, card: 200 };
            return { cash: 0, bv: 0, card: 0 };
        }
        function collectAllDescendants(startNode, list) { if (!startNode) return; list.push(startNode); collectAllDescendants(startNode.pathA, list); collectAllDescendants(startNode.pathB, list); }

        function calculateBonuses() {
            resetRewards(treeData); nodesCache = {}; parentMap = {}; buildCache(treeData, null); 
            traverseForSponsorBonus(treeData); calculateDirectSponsorVolume(treeData); calculatePairingBonus(treeData);
            calculateGlobalStats(); saveData();
        }

        function calculateDirectSponsorVolume(rootNode) {
            const allNodes = Object.values(nodesCache);
            allNodes.forEach(node => {
                let leftSubtreeNodes = []; collectAllDescendants(node.pathA, leftSubtreeNodes);
                let validLeftBV = 0; leftSubtreeNodes.forEach(child => { if (child.sponsorId === node.id) validLeftBV += getNodeBaseBV(child.level); });
                node.totalBvA = validLeftBV;
                let rightSubtreeNodes = []; collectAllDescendants(node.pathB, rightSubtreeNodes);
                let validRightBV = 0; rightSubtreeNodes.forEach(child => { if (child.sponsorId === node.id) validRightBV += getNodeBaseBV(child.level); });
                node.totalBvB = validRightBV;
            });
        }
        function calculatePairingBonus(node) { if (!node) return; const pairVolume = Math.min(node.totalBvA, node.totalBvB); if (pairVolume > 0) node.rewards.pairing = Math.round(pairVolume * 0.15 * 100) / 100; calculatePairingBonus(node.pathA); calculatePairingBonus(node.pathB); }
        function traverseForSponsorBonus(node) { if (!node) return; if (node.sponsorId && nodesCache[node.sponsorId]) { distributeReferralReward(nodesCache[node.sponsorId], node.level); } traverseForSponsorBonus(node.pathA); traverseForSponsorBonus(node.pathB); }
        function buildCache(node, parent) { if (!node) return; nodesCache[node.id] = node; if(parent) parentMap[node.id] = parent; buildCache(node.pathA, node); buildCache(node.pathB, node); }
        function resetRewards(node) { if (!node) return; node.rewards = { cash: 0, bv: 0, card: 0, pairing: 0 }; node.totalBvA = 0; node.totalBvB = 0; resetRewards(node.pathA); resetRewards(node.pathB); }
        function distributeReferralReward(sponsorNode, newMemberLevel) { if (sponsorNode.level === 'L1') return; const reward = getSponsorReward(newMemberLevel); sponsorNode.rewards.cash += reward.cash; sponsorNode.rewards.bv += reward.bv; sponsorNode.rewards.card += reward.card; }

        function calculateAndRender() { calculateBonuses(); renderTree(false); }

        let currentSelectingNodeId = null;
        function openSponsorModal(nodeId) {
            currentSelectingNodeId = nodeId; const container = document.getElementById('nodeListContainer'); container.innerHTML = '';
            nodesCache = {}; parentMap = {}; buildCache(treeData, null);
            let validSponsors = []; let curr = nodesCache[nodeId];
            while(curr && parentMap[curr.id]) { curr = parentMap[curr.id]; validSponsors.push(curr); }
            if (validSponsors.length === 0) { container.innerHTML = '<div style="padding:10px;text-align:center;opacity:0.6;">ÁÑ°ÂèØÈÅ∏Êé®Ëñ¶‰∫∫ (Â∑≤ÊòØÊúÄÈ´òÂ±§)</div>'; } 
            else {
                validSponsors.forEach(n => {
                    const item = document.createElement('div'); item.className = 'node-list-item';
                    item.innerHTML = `<div class="node-list-info"><span class="node-list-name">${n.name}</span><span class="node-list-id">ID: ${n.userID || '---'}</span></div><span class="node-list-level">${n.level}</span>`;
                    item.onclick = () => setSponsor(n.id); container.appendChild(item);
                });
            }
            document.getElementById('sponsorModal').classList.add('open');
        }
        function closeSponsorModal() { document.getElementById('sponsorModal').classList.remove('open'); }
        function setSponsor(sponsorId) { const node = nodesCache[currentSelectingNodeId]; if (node) { node.sponsorId = sponsorId; calculateAndRender(); } closeSponsorModal(); }
        function getSponsorName(id) { if (!id) return "ÁÑ°"; if (nodesCache[id]) return nodesCache[id].name; return "Êú™Áü•"; }

        const treeRootEl = document.getElementById('treeRoot');
        function findNode(root, id) { if (!root) return null; if (root.id === id) return root; return findNode(root.pathA, id) || findNode(root.pathB, id); }
        function findParent(root, childId) { if (!root) return null; if ((root.pathA && root.pathA.id === childId) || (root.pathB && root.pathB.id === childId)) return root; return findParent(root.pathA, childId) || findParent(root.pathB, childId); }
        function updateNodeData(id, key, value) { const node = findNode(treeData, id); if (node) { node[key] = value; if (key === 'level') calculateAndRender(); else saveData(); } }

        function addNode(parentId, pathKey) {
            const parent = findNode(treeData, parentId);
            if (parent) {
                parent[pathKey] = {
                    id: Date.now().toString(), userID: generateUserID(), name: getRandomName(), level: 'L4',
                    sponsorId: parent.id, pathA: null, pathB: null,
                    rewards: { cash: 0, bv: 0, card: 0, pairing: 0 }, totalBvA: 0, totalBvB: 0
                }; calculateAndRender();
            }
        }
        function deleteNode(nodeId) {
            if(nodeId === 'root' || !confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) return;
            const parent = findParent(treeData, nodeId);
            if (parent) { if (parent.pathA && parent.pathA.id === nodeId) parent.pathA = null; else if (parent.pathB && parent.pathB.id === nodeId) parent.pathB = null; calculateAndRender(); }
        }

        function renderTree(centerView = true) {
            nodesCache = {}; parentMap = {}; buildCache(treeData, null);
            treeRootEl.innerHTML = ''; treeRootEl.appendChild(createNodeElement(treeData));
        }

        function attachLongPress(element, callback) {
            let timer;
            const start = () => { if (element.classList.contains('edit-mode')) return; timer = setTimeout(() => { callback(); if (navigator.vibrate) navigator.vibrate(50); }, 600); };
            const cancel = () => { clearTimeout(timer); };
            element.addEventListener('touchstart', start, {passive: true}); element.addEventListener('touchend', cancel); element.addEventListener('touchmove', cancel); 
            element.addEventListener('mousedown', start); element.addEventListener('mouseup', cancel); element.addEventListener('mouseleave', cancel);
        }
        document.addEventListener('touchstart', (e) => { if (!e.target.closest('.node-card')) document.querySelectorAll('.node-card.edit-mode').forEach(el => el.classList.remove('edit-mode')); });
        document.addEventListener('mousedown', (e) => { if (!e.target.closest('.node-card')) document.querySelectorAll('.node-card.edit-mode').forEach(el => el.classList.remove('edit-mode')); });

        function createNodeElement(nodeData) {
            const wrapper = document.createElement('div'); wrapper.className = 'node-wrapper';
            const card = document.createElement('div'); card.className = 'node-card'; card.setAttribute('data-level', nodeData.level); card.id = `card-${nodeData.id}`;
            attachLongPress(card, () => { document.querySelectorAll('.node-card.edit-mode').forEach(el => el.classList.remove('edit-mode')); card.classList.add('edit-mode'); });
            if (nodeData.id !== 'root') {
                const delBtn = document.createElement('div'); delBtn.className = 'delete-btn'; delBtn.textContent = '√ó';
                delBtn.ontouchstart = (e) => e.stopPropagation(); delBtn.onclick = (e) => { e.stopPropagation(); deleteNode(nodeData.id); };
                card.appendChild(delBtn);
                const spBtn = document.createElement('div'); spBtn.className = 'sponsor-btn'; spBtn.innerHTML = 'üîó';
                spBtn.ontouchstart = (e) => e.stopPropagation(); spBtn.onclick = (e) => { e.stopPropagation(); openSponsorModal(nodeData.id); };
                card.appendChild(spBtn);
                const spLabel = document.createElement('div'); spLabel.className = 'sponsor-label'; spLabel.textContent = `Êé®: ${getSponsorName(nodeData.sponsorId)}`; card.appendChild(spLabel);
            }
            const avatar = document.createElement('div'); avatar.className = 'avatar-circle'; avatar.textContent = nodeData.name.charAt(0); card.appendChild(avatar);
            const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.className = 'node-name-input'; nameInput.value = nodeData.name;
            nameInput.oninput = (e) => { updateNodeData(nodeData.id, 'name', e.target.value); avatar.textContent = e.target.value.charAt(0); }; nameInput.ontouchstart = (e) => e.stopPropagation(); card.appendChild(nameInput);
            const idInput = document.createElement('input'); idInput.type = 'text'; idInput.className = 'node-userid-input'; idInput.value = nodeData.userID || ''; idInput.placeholder = 'ID';
            idInput.oninput = (e) => updateNodeData(nodeData.id, 'userID', e.target.value); idInput.ontouchstart = (e) => e.stopPropagation(); card.appendChild(idInput);
            const levelSelect = document.createElement('select'); levelSelect.className = 'node-level-select';
            ['L1', 'L2', 'L3', 'L4'].forEach(lvl => { const opt = document.createElement('option'); opt.value = lvl; opt.textContent = lvl; if (nodeData.level === lvl) opt.selected = true; levelSelect.appendChild(opt); });
            levelSelect.onchange = (e) => updateNodeData(nodeData.id, 'level', e.target.value); levelSelect.ontouchstart = (e) => e.stopPropagation(); card.appendChild(levelSelect);
            const statsDiv = document.createElement('div'); statsDiv.className = 'node-stats';
            statsDiv.innerHTML += `<div class="stat-row"><span>Áõ¥Êé®</span><span class="stat-value stat-cash">$${nodeData.rewards.cash}</span></div>`;
            statsDiv.innerHTML += `<div class="stat-row"><span>Á©çÂàÜ</span><span class="stat-value stat-bv">$${nodeData.rewards.pairing || 0}</span></div>`;
            if (nodeData.rewards.card > 0) statsDiv.innerHTML += `<div class="stat-row"><span>Áî¢ÂìÅ</span><span class="stat-value stat-card">$${nodeData.rewards.card}</span></div>`;
            card.appendChild(statsDiv); wrapper.appendChild(card);
            const childrenContainer = document.createElement('div'); childrenContainer.className = 'children-container';
            const branchA = createBranch(nodeData, 'pathA'); if (nodeData.pathA || nodeData.totalBvA > 0) { const bvTagA = document.createElement('div'); bvTagA.className = 'line-bv-tag'; bvTagA.textContent = `${nodeData.totalBvA} BV`; branchA.appendChild(bvTagA); } childrenContainer.appendChild(branchA);
            const branchB = createBranch(nodeData, 'pathB'); if (nodeData.pathB || nodeData.totalBvB > 0) { const bvTagB = document.createElement('div'); bvTagB.className = 'line-bv-tag'; bvTagB.textContent = `${nodeData.totalBvB} BV`; branchB.appendChild(bvTagB); } childrenContainer.appendChild(branchB);
            wrapper.appendChild(childrenContainer); return wrapper;
        }

        function createBranch(parentNode, pathKey) {
            const branch = document.createElement('div'); branch.className = 'branch';
            const content = document.createElement('div'); content.className = 'branch-content';
            if (parentNode[pathKey]) content.appendChild(createNodeElement(parentNode[pathKey]));
            else {
                const addBtn = document.createElement('button'); addBtn.className = 'add-btn'; addBtn.textContent = '+';
                addBtn.onclick = () => addNode(parentNode.id, pathKey); addBtn.ontouchstart = (e) => e.stopPropagation();
                content.appendChild(addBtn);
            }
            branch.appendChild(content); return branch;
        }

        const viewport = document.getElementById('viewport'); const panLayer = document.getElementById('panLayer');
        let scale = 1, translateX = 0, translateY = 0, isDragging = false, startX, startY;
        let startDist = 0, startScale = 1, startCenterX = 0, startCenterY = 0, startTranslateX = 0, startTranslateY = 0;
        
        let clickCount = 0; let clickTimer = null;
        function handleTripleClick() {
            clickCount++;
            if (clickCount === 1) { clickTimer = setTimeout(() => { clickCount = 0; }, 400); } 
            else if (clickCount === 3) { clearTimeout(clickTimer); clickCount = 0; resetView(); if (navigator.vibrate) navigator.vibrate([50, 30, 50]); }
        }

        function updateTransform() { panLayer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; }
        function resetView() {
            scale = 1; panLayer.classList.add('smooth-move');
            const layerWidth = panLayer.offsetWidth; const viewWidth = viewport.clientWidth;
            translateX = (viewWidth - layerWidth) / 2; translateY = 40; 
            panLayer.style.transform = `translate(${translateX}px, ${translateY}px) scale(1)`;
            updateTransform(); 
            // Â¶ÇÊûúÁµ±Ë®àÊ¨ÑÈñãËëóÔºåÈóúÈñâÂÆÉ‰ª•‰æøÈáçÁΩÆË¶ñÂúñÊôÇÁúãÂæóÊõ¥Ê∏ÖÊ•ö
            document.getElementById('statsBar').classList.remove('expanded');
            setTimeout(() => panLayer.classList.remove('smooth-move'), 300);
        }

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault(); panLayer.classList.remove('smooth-move');
            const newScale = Math.min(Math.max(0.2, scale + (-e.deltaY) * 0.001), 3);
            const rect = panLayer.getBoundingClientRect(); const ratio = newScale / scale;
            translateX -= (e.clientX - rect.left) * (ratio - 1); translateY -= (e.clientY - rect.top) * (ratio - 1);
            scale = newScale; updateTransform();
        }, { passive: false });

        viewport.addEventListener('mousedown', (e) => {
            if (['INPUT','SELECT','BUTTON'].includes(e.target.tagName) || e.target.closest('.node-card')) return;
            handleTripleClick(); panLayer.classList.remove('smooth-move'); isDragging = true; startX = e.clientX - translateX; startY = e.clientY - translateY; viewport.style.cursor = 'grabbing';
        });
        window.addEventListener('mousemove', (e) => { if (!isDragging) return; e.preventDefault(); translateX = e.clientX - startX; translateY = e.clientY - startY; updateTransform(); });
        window.addEventListener('mouseup', () => { isDragging = false; viewport.style.cursor = 'grab'; });

        function getDistance(touches) { return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY); }
        function getCenter(touches) { return { x: (touches[0].clientX + touches[1].clientX) / 2, y: (touches[0].clientY + touches[1].clientY) / 2 }; }

        viewport.addEventListener('touchstart', (e) => {
            if (e.target.closest('input') || e.target.closest('select') || e.target.closest('button')) return;
            panLayer.classList.remove('smooth-move');
            if (e.touches.length === 1) { handleTripleClick(); isDragging = true; startX = e.touches[0].clientX - translateX; startY = e.touches[0].clientY - translateY; }
            else if (e.touches.length === 2) {
                isDragging = false; startDist = getDistance(e.touches); startScale = scale;
                const center = getCenter(e.touches); startCenterX = center.x; startCenterY = center.y; startTranslateX = translateX; startTranslateY = translateY;
            }
        }, { passive: false });

        viewport.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) { translateX = e.touches[0].clientX - startX; translateY = e.touches[0].clientY - startY; updateTransform(); }
            else if (e.touches.length === 2) {
                const currDist = getDistance(e.touches); const currCenter = getCenter(e.touches);
                let newScale = Math.min(Math.max(0.2, startScale * (currDist / startDist)), 5);
                const ratio = newScale / startScale;
                translateX = currCenter.x - (startCenterX - startTranslateX) * ratio; translateY = currCenter.y - (startCenterY - startTranslateY) * ratio;
                scale = newScale; updateTransform();
            }
        }, { passive: false });
        viewport.addEventListener('touchend', (e) => { isDragging = false; if (e.touches.length < 2) startDist = 0; });

        const themeToggleBtn = document.getElementById('themeToggle'); const themes = ['auto', 'light', 'dark']; let currentThemeIndex = 0;
        function applyTheme(t) {
            document.documentElement.removeAttribute('data-theme');
            let sys = window.matchMedia('(prefers-color-scheme: dark)').matches;
            themeToggleBtn.textContent = `Â§ñËßÄ: ${t === 'auto' ? 'Ëá™Âãï' : (t === 'light' ? 'Ê∑∫Ëâ≤' : 'Ê∑±Ëâ≤')}`;
            if (t === 'dark' || (t === 'auto' && sys)) document.documentElement.setAttribute('data-theme', 'dark');
            else document.documentElement.setAttribute('data-theme', 'light');
        }
        themeToggleBtn.addEventListener('click', () => { currentThemeIndex = (currentThemeIndex + 1) % themes.length; applyTheme(themes[currentThemeIndex]); });

        function downloadJSON() {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(treeData, null, 2));
            a.download = "iHealth_tree_v20_integrated.json"; document.body.appendChild(a); a.click(); a.remove();
        }
        function importJSON(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    const fix = (n) => { if(!n)return; if(n.userID===undefined)n.userID=generateUserID(); if(n.sponsorId===undefined)n.sponsorId=null; if(n.totalBvA===undefined)n.totalBvA=0; if(n.totalBvB===undefined)n.totalBvB=0; if(n.rewards.pairing===undefined)n.rewards.pairing=0; fix(n.pathA); fix(n.pathB); };
                    fix(d); treeData = d; calculateAndRender(); input.value = '';
                } catch(err) { alert('JSON Error'); }
            }; r.readAsText(f);
        }

        applyTheme('auto'); 
        initData(); 
        calculateAndRender();
        window.onload = function() { setTimeout(resetView, 100); };
    </script>
</body>
</html>
